{"version":3,"sources":["../../src/panel/module.js"],"names":["_","$","moment","PanelCtrl","LightStepPanelCtrl","$scope","$injector","panelDefaults","project","operationID","embed_url","lightstepURL","panel","ctrl","dashboard","timeSrv","get","refresh","_refresh","bind","iframeID","Math","floor","random","defaults","events","on","debounce","setTimeout","onInitEditMode","split_url","split","length","lsURL","generateLink","timeRange","attr","oldestUnix","from","unix","youngestUnix","to","range","url","timezone","addEditorTab","template"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAOA,O;;AACAC,O;;AACAC,Y;;AACCC,e,kBAAAA,S;;;;;;;;;;;;;;;;;;;;;2BAGFC,kB;;;AAEJ,oCAAYC,MAAZ,EAAoBC,SAApB,EAA+B;AAAA;;AAAA,8IACvBD,MADuB,EACfC,SADe;;AAE7B,cAAMC,gBAAgB;AACpBC,qBAAS,EADW;AAEpBC,yBAAa,EAFO;AAGpBC,uBAAW,EAHS,CAGN;AAHM,WAAtB;;AAMA,gBAAKC,YAAL,GAAoB,2BAApB;AACA,gBAAKC,KAAL,GAAaP,OAAOQ,IAAP,CAAYD,KAAzB;AACA,gBAAKE,SAAL,GAAiBT,OAAOQ,IAAP,CAAYC,SAA7B;AACA,gBAAKC,OAAL,GAAeT,UAAUU,GAAV,CAAc,SAAd,CAAf;AACA,gBAAKC,OAAL,GAAe,MAAKC,QAAL,CAAcC,IAAd,OAAf;AACA,gBAAKC,QAAL,GAAmBC,KAAKC,KAAL,CAAWD,KAAKE,MAAL,KAAc,IAAzB,CAAnB,SAAqD,MAAKX,KAAL,CAAWH,WAAhE;;AAEAT,YAAEwB,QAAF,CAAW,MAAKZ,KAAhB,EAAuBL,aAAvB;;AAEA;AACA;AACA;AACA,gBAAKkB,MAAL,CAAYC,EAAZ,CAAe,SAAf,EAA0B1B,EAAE2B,QAAF,CAAW,MAAKV,OAAhB,EAAyB,GAAzB,CAA1B;AACAW,qBAAW,MAAKX,OAAhB,EAAyB,GAAzB;;AAEA,gBAAKQ,MAAL,CAAYC,EAAZ,CAAe,gBAAf,EAAiC,MAAKG,cAAL,CAAoBV,IAApB,OAAjC;AAvB6B;AAwB9B;;AAED;;;;;qCACW;AACT;AACA,gBAAI,KAAKP,KAAL,CAAWF,SAAf,EAA0B;;AAExB;AACA;AACA,kBAAMoB,YAAY,KAAKlB,KAAL,CAAWF,SAAX,CAAqBqB,KAArB,CAA2B,GAA3B,CAAlB;AACA,kBAAID,UAAUE,MAAV,GAAmB,CAAvB,EAA0B;AACxB,qBAAKpB,KAAL,CAAWJ,OAAX,GAAqBsB,UAAU,CAAV,CAArB;AACA,qBAAKlB,KAAL,CAAWH,WAAX,GAAyBqB,UAAU,CAAV,CAAzB;AACD;AACF;;AAED,gBAAMtB,UAAU,KAAKI,KAAL,CAAWJ,OAA3B;AACA,gBAAMC,cAAc,KAAKG,KAAL,CAAWH,WAA/B;;AAEA,gBAAMwB,QAAQ,KAAKC,YAAL,CAAkB,KAAKnB,OAAL,CAAaoB,SAAb,EAAlB,EAA4C3B,OAA5C,EAAqDC,WAArD,CAAd;AACAR,oBAAM,KAAKmB,QAAX,EAAuBgB,IAAvB,CAA4B,KAA5B,EAAmCH,KAAnC;AACD;;;uCAGYE,S,EAAW3B,O,EAASC,W,EAAa;AAC5C,gBAAM4B,aAAaF,UAAUG,IAAV,CAAeC,IAAf,EAAnB;AACA,gBAAMC,eAAgBL,UAAUM,EAAV,CAAaF,IAAb,EAAtB;AACA,gBAAMG,QAASF,eAAeH,UAA9B;AACA,gBAAIM,MAAS,KAAKhC,YAAd,SAA8BH,OAA9B,mBAAmDC,WAAnD,qBAA8EiC,KAA9E,gBAA8FF,YAAlG;AACA,gBAAI,KAAK1B,SAAL,CAAe8B,QAAf,KAA4B,KAAhC,EAAuC;AACrCD,oBAAMA,MAAM,WAAZ;AACD;AACD,mBAAOA,GAAP;AACD;;;2CAEgB;AACf,iBAAKE,YAAL,CAAkB,mBAAlB,EAAuC,4CAAvC;AACD;;;;QA/D8B1C,S;;AAkEjC;AACA;AACAC,yBAAmB0C,QAAnB;;2BAIE1C,kB","file":"module.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport moment from 'moment'\nimport {PanelCtrl} from  'app/plugins/sdk';\n\n\nclass LightStepPanelCtrl extends PanelCtrl {\n\n  constructor($scope, $injector) {\n    super($scope, $injector);\n    const panelDefaults = {\n      project: '',\n      operationID: '',\n      embed_url: '' // embed_url takes precedence over project and operationID\n    }\n\n    this.lightstepURL = 'https://app.lightstep.com';\n    this.panel = $scope.ctrl.panel;\n    this.dashboard = $scope.ctrl.dashboard;\n    this.timeSrv = $injector.get('timeSrv');\n    this.refresh = this._refresh.bind(this);\n    this.iframeID = `${Math.floor(Math.random()*1000)}-${this.panel.operationID}-ls-panel`\n\n    _.defaults(this.panel, panelDefaults);\n\n    // There's a race condition where the first refresh event might be called before the iFrame is\n    // is rendered with the correct ID meaning jQuery doesn't find it, which is why we make a\n    // a delayed call to refresh().\n    this.events.on('refresh', _.debounce(this.refresh, 500));\n    setTimeout(this.refresh, 500);\n\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n  }\n\n  // _refresh uses jQuery to embed a new link inside the iFrame.\n  _refresh() {\n    // The URL gets precedent over the JSON fields component and operation\n    if (this.panel.embed_url) {\n\n      // Assumes a well-formed embed URL like:\n      // https://app.lightstep.com/loadtest/operation/rmJRsvcR/embed?range=86400\n      const split_url = this.panel.embed_url.split('/')\n      if (split_url.length > 6) {\n        this.panel.project = split_url[3];\n        this.panel.operationID = split_url[5];\n      }\n    }\n\n    const project = this.panel.project;\n    const operationID = this.panel.operationID;\n\n    const lsURL = this.generateLink(this.timeSrv.timeRange(), project, operationID);\n    $(`#${this.iframeID}`).attr('src', lsURL);\n  }\n\n  // generateLink generates a new embedded link based off the current timerange.\n  generateLink(timeRange, project, operationID) {\n    const oldestUnix = timeRange.from.unix();\n    const youngestUnix =  timeRange.to.unix();\n    const range  = youngestUnix - oldestUnix;\n    let url = `${this.lightstepURL}/${project}/operation/${operationID}/embed?range=${range}&anchor=${youngestUnix}`;\n    if (this.dashboard.timezone === 'utc') {\n      url = url + '&utc=true';\n    }\n    return url;\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('LightStep Options', 'public/plugins/lightstep-panel/editor.html');\n  }\n}\n\n// We overlay a div in the bottom right corner to prevent the panel resizer from losing control of\n// the mouse to the iFrame.\nLightStepPanelCtrl.template = `<iframe id={{ctrl.iframeID}} height={{ctrl.height}}px width=100% class=\"lightstep-grafana-panel\"></iframe>\n  <div style=\"position: absolute; bottom: 0; right: 0; height: 50px; width: 50px\"></div>`;\n\nexport {\n  LightStepPanelCtrl as PanelCtrl\n};\n"]}