{"version":3,"sources":["../../src/panel/module.js"],"names":["_","$","moment","PanelCtrl","LightstepPanelCtrl","$scope","$injector","panelDefaults","project","operationID","lightstepURL","panel","ctrl","timeSrv","get","refresh","_refresh","bind","iframeID","format","defaults","events","on","setTimeout","onInitEditMode","lsURL","generateLink","timeRange","attr","oldestUnix","from","unix","youngestUnix","to","range","addEditorTab","template"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAOA,O;;AACAC,O;;AACAC,Y;;AACCC,e,kBAAAA,S;;;;;;;;;;;;;;;;;;;;;2BAGFC,kB;;;AAEJ,oCAAYC,MAAZ,EAAoBC,SAApB,EAA+B;AAAA;;AAAA,8IACvBD,MADuB,EACfC,SADe;;AAE7B,cAAMC,gBAAgB;AACpBC,qBAAS,EADW;AAEpBC,yBAAa;AAFO,WAAtB;;AAKA,gBAAKC,YAAL,GAAoB,2BAApB;AACA,gBAAKC,KAAL,GAAaN,OAAOO,IAAP,CAAYD,KAAzB;AACA,gBAAKE,OAAL,GAAeP,UAAUQ,GAAV,CAAc,SAAd,CAAf;AACA,gBAAKC,OAAL,GAAe,MAAKC,QAAL,CAAcC,IAAd,OAAf;AACA,gBAAKC,QAAL,GAAmBhB,SAASiB,MAAT,CAAgB,GAAhB,CAAnB;;AAEAnB,YAAEoB,QAAF,CAAW,MAAKT,KAAhB,EAAuBJ,aAAvB;;AAEA;AACA;AACA;AACA,gBAAKc,MAAL,CAAYC,EAAZ,CAAe,SAAf,EAA0B,MAAKP,OAA/B;AACAQ,qBAAW,MAAKR,OAAhB,EAAyB,GAAzB;;AAEA,gBAAKM,MAAL,CAAYC,EAAZ,CAAe,gBAAf,EAAiC,MAAKE,cAAL,CAAoBP,IAApB,OAAjC;AArB6B;AAsB9B;;AAED;;;;;qCACW;AACT,gBAAMQ,QAAQ,KAAKC,YAAL,CAAkB,KAAKb,OAAL,CAAac,SAAb,EAAlB,EAA4C,KAAKhB,KAAL,CAAWH,OAAvD,EAAgE,KAAKG,KAAL,CAAWF,WAA3E,CAAd;AACAR,oBAAM,KAAKiB,QAAX,EAAuBU,IAAvB,CAA4B,KAA5B,EAAmCH,KAAnC;AACD;;;uCAGYE,S,EAAWnB,O,EAASC,W,EAAa;AAC5C,gBAAMoB,aAAaF,UAAUG,IAAV,CAAeC,IAAf,EAAnB;AACA,gBAAMC,eAAgBL,UAAUM,EAAV,CAAaF,IAAb,EAAtB;AACA,gBAAMG,QAASF,eAAeH,UAA9B;AACA,mBAAU,KAAKnB,YAAf,SAA+BF,OAA/B,gBAAiDC,WAAjD,qBAA4EyB,KAA5E,gBAA4FF,YAA5F;AACD;;;2CAEgB;AACf,iBAAKG,YAAL,CAAkB,mBAAlB,EAAuC,4CAAvC;AACD;;;;QA1C8BhC,S;;AA6CjCC,yBAAmBgC,QAAnB,GAA8B,4GAA9B;;2BAGEhC,kB","file":"module.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport moment from 'moment'\nimport {PanelCtrl} from  'app/plugins/sdk';\n\n\nclass LightstepPanelCtrl extends PanelCtrl {\n\n  constructor($scope, $injector) {\n    super($scope, $injector);\n    const panelDefaults = {\n      project: '',\n      operationID: ''\n    }\n\n    this.lightstepURL = 'https://app.lightstep.com';\n    this.panel = $scope.ctrl.panel;\n    this.timeSrv = $injector.get('timeSrv');\n    this.refresh = this._refresh.bind(this);\n    this.iframeID = `${moment().format('X')}-ls-panel`\n\n    _.defaults(this.panel, panelDefaults);\n\n    // There's a race condition where the first refresh event might be called before the iFrame is\n    // is rendered with the correct ID meaning jQuery doesn't find it, which is why we make a\n    // a delayed call to refresh().\n    this.events.on('refresh', this.refresh);\n    setTimeout(this.refresh, 500);\n\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n  }\n\n  // _refresh uses jQuery to embed a new link inside the iFrame.\n  _refresh() {\n    const lsURL = this.generateLink(this.timeSrv.timeRange(), this.panel.project, this.panel.operationID);\n    $(`#${this.iframeID}`).attr('src', lsURL);\n  }\n\n  // generateLink generates a new embedded link based off the current timerange.\n  generateLink(timeRange, project, operationID) {\n    const oldestUnix = timeRange.from.unix();\n    const youngestUnix =  timeRange.to.unix();\n    const range  = youngestUnix - oldestUnix;\n    return `${this.lightstepURL}/${project}/search/${operationID}/embed?range=${range}&anchor=${youngestUnix}`;\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('LightStep Options', 'public/plugins/lightstep-panel/editor.html');\n  }\n}\n\nLightstepPanelCtrl.template = '<iframe id={{ctrl.iframeID}} height={{ctrl.height}}px width=100% class=\"lightstep-grafana-panel\"></iframe>';\n\nexport {\n  LightstepPanelCtrl as PanelCtrl\n};\n"]}