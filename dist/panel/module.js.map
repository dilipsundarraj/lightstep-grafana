{"version":3,"sources":["../../src/panel/module.js"],"names":["_","$","moment","PanelCtrl","LightStepPanelCtrl","$scope","$injector","panelDefaults","project","operationID","embed_url","y_max","filter_duration","filter_percentile","filter_errors","dark_theme","lightstepURL","panel","ctrl","dashboard","timeSrv","get","refresh","debounce","_refresh","bind","iframeID","Math","floor","random","defaults","events","on","setTimeout","onInitEditMode","parser","document","createElement","href","split_url","pathname","split","length","decodeURI","params_arr","search","slice","params","forEach","param","kv","lsURL","generateLink","timeRange","attr","proj","encodeURIComponent","opID","oldestUnix","from","unix","youngestUnix","to","range","query","timezone","queryString","join","map","val","key","url","addEditorTab","template"],"mappings":"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","file":"module.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport moment from 'moment'\nimport {PanelCtrl} from  'app/plugins/sdk';\n\n\nclass LightStepPanelCtrl extends PanelCtrl {\n\n  constructor($scope, $injector) {\n    super($scope, $injector);\n    const panelDefaults = {\n      project: '',\n      operationID: '',\n      embed_url: '', // embed_url takes precedence over all other options.\n      y_max: '',\n      filter_duration: '',\n      filter_percentile: '',\n      filter_errors: '',\n      dark_theme: 'true',\n    }\n\n    this.lightstepURL = 'https://app.lightstep.com';\n    this.panel = $scope.ctrl.panel;\n    this.dashboard = $scope.ctrl.dashboard;\n    this.timeSrv = $injector.get('timeSrv');\n    this.refresh = _.debounce(this._refresh.bind(this), 500);\n    this.iframeID = `${Math.floor(Math.random()*1000)}-${this.panel.operationID}-ls-panel`\n\n    _.defaults(this.panel, panelDefaults);\n\n    // There's a race condition where the first refresh event might be called before the iFrame is\n    // is rendered with the correct ID meaning jQuery doesn't find it, which is why we make a\n    // a delayed call to refresh().\n    this.events.on('refresh', this.refresh);\n    setTimeout(this.refresh, 500);\n\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n  }\n\n  // _refresh uses jQuery to embed a new link inside the iFrame.\n  _refresh() {\n    // The URL gets precedent over the JSON fields component and operation\n    if (this.panel.embed_url) {\n      // URI Parsing based on gist.github.com/jlong/2428561\n      // Assumes a well-formed embed URL like:\n      // https://app.lightstep.com/loadtest/operation/rmJRsvcR/embed?range=86400\n      var parser = document.createElement('a');\n      parser.href = this.panel.embed_url;\n      const split_url = parser.pathname.split('/')\n      if (split_url.length > 4) {\n        this.panel.project = decodeURI(split_url[1]);\n        this.panel.operationID = decodeURI(split_url[3]);\n      }\n      // parser.search returns \"?k=v\" so we slice off the '?', then break the string into an array\n      // of kv pairs.\n      const params_arr = parser.search.slice(1).split('&');\n      let params = {};\n      params_arr.forEach((param) => {\n        const kv = param.split(\"=\");\n        params[decodeURI(kv[0])] = decodeURI(kv[1]);\n      })\n      this.panel.y_max = params['ymax'] ? params['ymax'] : '';\n      this.panel.filter_errors = params['filter_errors'] ? params['filter_errors'] : '';\n      this.panel.filter_percentile = params['filter_percentile'] ? params['filter_percentile'] : '';\n      this.panel.filter_duration = params['filter_duration'] ? params['filter_duration'] : '';\n      this.panel.dark_theme = params['dark_theme'] ? params['dark_theme'] : 'true';\n    }\n\n    const project = this.panel.project;\n    const operationID = this.panel.operationID;\n\n    const lsURL = this.generateLink(this.timeSrv.timeRange(), project, operationID);\n    $(`#${this.iframeID}`).attr('src', lsURL);\n  }\n\n  // generateLink generates a new embedded link based off the current timerange.\n  generateLink(timeRange, project, operationID) {\n    const proj = encodeURIComponent(project);\n    const opID = encodeURIComponent(operationID);\n    const oldestUnix = timeRange.from.unix();\n    const youngestUnix =  timeRange.to.unix();\n    const range  = youngestUnix - oldestUnix;\n    let query = {\n      'range': range,\n      'anchor': youngestUnix\n    }\n    if (this.dashboard.timezone === 'utc') {\n     query['utc'] = 'true';\n    }\n    if (this.panel.y_max) {\n      query['ymax'] = this.panel.y_max;\n    }\n    if (this.panel.filter_errors) {\n      query['filter_errors'] = this.panel.filter_errors;\n    }\n    if (this.panel.filter_errors) {\n      query['filter_duration'] = this.panel.filter_duration;\n    }\n    if (this.panel.filter_percentile) {\n      query['filter_percentile'] = this.panel.filter_percentile;\n    }\n    if (this.panel.dark_theme) {\n      query['dark_theme'] = this.panel.dark_theme;\n    }\n    let queryString = _.join(_.map(query, (val, key) => { return `${key}=${val}` }), '&')\n    let url = `${this.lightstepURL}/${proj}/operation/${opID}/embed?${queryString}`\n    return url;\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('LightStep Options', 'public/plugins/lightstep-panel/editor.html');\n  }\n}\n\n// We overlay a div in the bottom right corner to prevent the panel resizer from losing control of\n// the mouse to the iFrame.\nLightStepPanelCtrl.template = `<iframe id={{ctrl.iframeID}} height={{ctrl.height}}px width=100% class=\"lightstep-grafana-panel\"></iframe>\n  <div style=\"position: absolute; bottom: 0; right: 0; height: 50px; width: 50px\"></div>`;\n\nexport {\n  LightStepPanelCtrl as PanelCtrl\n};\n"]}