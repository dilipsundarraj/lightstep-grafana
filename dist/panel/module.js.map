{"version":3,"sources":["../../src/panel/module.js"],"names":["_","$","moment","PanelCtrl","LightStepPanelCtrl","$scope","$injector","panelDefaults","project","operationID","lightstepURL","panel","ctrl","dashboard","timeSrv","get","refresh","_refresh","bind","iframeID","Math","floor","random","defaults","events","on","setTimeout","onInitEditMode","lsURL","generateLink","timeRange","attr","oldestUnix","from","unix","youngestUnix","to","range","url","timezone","addEditorTab","template"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAOA,O;;AACAC,O;;AACAC,Y;;AACCC,e,kBAAAA,S;;;;;;;;;;;;;;;;;;;;;2BAGFC,kB;;;AAEJ,oCAAYC,MAAZ,EAAoBC,SAApB,EAA+B;AAAA;;AAAA,8IACvBD,MADuB,EACfC,SADe;;AAE7B,cAAMC,gBAAgB;AACpBC,qBAAS,EADW;AAEpBC,yBAAa;AAFO,WAAtB;;AAKA,gBAAKC,YAAL,GAAoB,2BAApB;AACA,gBAAKC,KAAL,GAAaN,OAAOO,IAAP,CAAYD,KAAzB;AACA,gBAAKE,SAAL,GAAiBR,OAAOO,IAAP,CAAYC,SAA7B;AACA,gBAAKC,OAAL,GAAeR,UAAUS,GAAV,CAAc,SAAd,CAAf;AACA,gBAAKC,OAAL,GAAe,MAAKC,QAAL,CAAcC,IAAd,OAAf;AACA,gBAAKC,QAAL,GAAmBC,KAAKC,KAAL,CAAWD,KAAKE,MAAL,KAAc,IAAzB,CAAnB,SAAqD,MAAKX,KAAL,CAAWF,WAAhE;;AAEAT,YAAEuB,QAAF,CAAW,MAAKZ,KAAhB,EAAuBJ,aAAvB;;AAEA;AACA;AACA;AACA,gBAAKiB,MAAL,CAAYC,EAAZ,CAAe,SAAf,EAA0B,MAAKT,OAA/B;AACAU,qBAAW,MAAKV,OAAhB,EAAyB,GAAzB;;AAEA,gBAAKQ,MAAL,CAAYC,EAAZ,CAAe,gBAAf,EAAiC,MAAKE,cAAL,CAAoBT,IAApB,OAAjC;AAtB6B;AAuB9B;;AAED;;;;;qCACW;AACT,gBAAMU,QAAQ,KAAKC,YAAL,CAAkB,KAAKf,OAAL,CAAagB,SAAb,EAAlB,EAA4C,KAAKnB,KAAL,CAAWH,OAAvD,EAAgE,KAAKG,KAAL,CAAWF,WAA3E,CAAd;AACAR,oBAAM,KAAKkB,QAAX,EAAuBY,IAAvB,CAA4B,KAA5B,EAAmCH,KAAnC;AACD;;;uCAGYE,S,EAAWtB,O,EAASC,W,EAAa;AAC5C,gBAAMuB,aAAaF,UAAUG,IAAV,CAAeC,IAAf,EAAnB;AACA,gBAAMC,eAAgBL,UAAUM,EAAV,CAAaF,IAAb,EAAtB;AACA,gBAAMG,QAASF,eAAeH,UAA9B;AACA,gBAAIM,MAAS,KAAK5B,YAAd,SAA8BF,OAA9B,mBAAmDC,WAAnD,qBAA8E4B,KAA9E,gBAA8FF,YAAlG;AACA,gBAAI,KAAKtB,SAAL,CAAe0B,QAAf,KAA4B,KAAhC,EAAuC;AACrCD,oBAAMA,MAAM,WAAZ;AACD;AACD,mBAAOA,GAAP;AACD;;;2CAEgB;AACf,iBAAKE,YAAL,CAAkB,mBAAlB,EAAuC,4CAAvC;AACD;;;;QA/C8BrC,S;;AAkDjC;AACA;AACAC,yBAAmBqC,QAAnB;;2BAIErC,kB","file":"module.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport moment from 'moment'\nimport {PanelCtrl} from  'app/plugins/sdk';\n\n\nclass LightStepPanelCtrl extends PanelCtrl {\n\n  constructor($scope, $injector) {\n    super($scope, $injector);\n    const panelDefaults = {\n      project: '',\n      operationID: ''\n    }\n\n    this.lightstepURL = 'https://app.lightstep.com';\n    this.panel = $scope.ctrl.panel;\n    this.dashboard = $scope.ctrl.dashboard;\n    this.timeSrv = $injector.get('timeSrv');\n    this.refresh = this._refresh.bind(this);\n    this.iframeID = `${Math.floor(Math.random()*1000)}-${this.panel.operationID}-ls-panel`\n\n    _.defaults(this.panel, panelDefaults);\n\n    // There's a race condition where the first refresh event might be called before the iFrame is\n    // is rendered with the correct ID meaning jQuery doesn't find it, which is why we make a\n    // a delayed call to refresh().\n    this.events.on('refresh', this.refresh);\n    setTimeout(this.refresh, 500);\n\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n  }\n\n  // _refresh uses jQuery to embed a new link inside the iFrame.\n  _refresh() {\n    const lsURL = this.generateLink(this.timeSrv.timeRange(), this.panel.project, this.panel.operationID);\n    $(`#${this.iframeID}`).attr('src', lsURL);\n  }\n\n  // generateLink generates a new embedded link based off the current timerange.\n  generateLink(timeRange, project, operationID) {\n    const oldestUnix = timeRange.from.unix();\n    const youngestUnix =  timeRange.to.unix();\n    const range  = youngestUnix - oldestUnix;\n    let url = `${this.lightstepURL}/${project}/operation/${operationID}/embed?range=${range}&anchor=${youngestUnix}`;\n    if (this.dashboard.timezone === 'utc') {\n      url = url + '&utc=true';\n    }\n    return url;\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('LightStep Options', 'public/plugins/lightstep-panel/editor.html');\n  }\n}\n\n// We overlay a div in the bottom right corner to prevent the panel resizer from losing control of\n// the mouse to the iFrame.\nLightStepPanelCtrl.template = `<iframe id={{ctrl.iframeID}} height={{ctrl.height}}px width=100% class=\"lightstep-grafana-panel\"></iframe>\n  <div style=\"position: absolute; bottom: 0; right: 0; height: 50px; width: 50px\"></div>`;\n\nexport {\n  LightStepPanelCtrl as PanelCtrl\n};\n"]}